# Laravel Passport OAuth Key Permission Fix (Docker / Production)

## ğŸ“Œ Problem

While calling login API, application returns **500 Internal Server
Error**:

    Key path "file:///var/www/storage/oauth-private.key"
    does not exist or is not readable

Even though the key files already exist.

------------------------------------------------------------------------

## ğŸ” Root Cause

Laravel Passport requires access to encryption keys:

    storage/oauth-private.key
    storage/oauth-public.key

In Docker/production environments:

-   Keys are often generated by **root**
-   Web server (Nginx / Apache / PHP-FPM) runs as **www-data**
-   Result â†’ Laravel cannot read the keys

So the file exists âœ… but is **not readable** âŒ.

------------------------------------------------------------------------

## âœ… How to Verify

Run:

``` bash
ls -l storage/oauth*
```

Example problematic output:

    -rw------- 1 root root oauth-private.key
    -rw-rw---- 1 root root oauth-public.key

If owner is `root`, Laravel will fail.

------------------------------------------------------------------------

## âœ… Fix (Permanent Solution)

Change ownership of Passport keys:

``` bash
chown www-data:www-data storage/oauth-private.key
chown www-data:www-data storage/oauth-public.key
```

------------------------------------------------------------------------

## ğŸ” Recommended Permissions

Set secure permissions:

``` bash
chmod 600 storage/oauth-private.key
chmod 600 storage/oauth-public.key
```

Explanation:

  Permission   Meaning
  ------------ -----------------------------------------------------
  600          Only owner can read/write (secure for private keys)

------------------------------------------------------------------------

## âœ… Fix Storage Permissions (Recommended)

``` bash
chown -R www-data:www-data storage
chown -R www-data:www-data bootstrap/cache

chmod -R 775 storage
chmod -R 775 bootstrap/cache
```

------------------------------------------------------------------------

## ğŸ§¹ Clear Laravel Cache

``` bash
php artisan optimize:clear
```

------------------------------------------------------------------------

## ğŸ”„ Restart Container / PHP

Docker:

``` bash
docker restart <container_name>
```

or restart PHP-FPM service.

------------------------------------------------------------------------

## âœ… Verify Fix

Run again:

``` bash
ls -l storage/oauth*
```

Expected output:

    -rw------- 1 www-data www-data oauth-private.key
    -rw------- 1 www-data www-data oauth-public.key

Login API should now work correctly.

------------------------------------------------------------------------

## ğŸš€ Deployment Best Practice (IMPORTANT)

Add this step to deployment scripts:

``` bash
php artisan passport:keys --force
chown -R www-data:www-data storage
php artisan optimize
```

This prevents permission issues after every deploy.

------------------------------------------------------------------------

## ğŸ§  Why This Happens

Docker containers commonly:

-   generate files using root user
-   run web services using www-data user

Mismatch in ownership causes Laravel Passport authentication failure.

------------------------------------------------------------------------

## âœ… Status

-   OAuth keys readable âœ”
-   Token generation working âœ”
-   Login API fixed âœ”

------------------------------------------------------------------------

## ğŸ“… Added For Future Reference

Keep this document for debugging Passport authentication issues in
production deployments.
